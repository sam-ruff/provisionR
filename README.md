# provisionR

Generate Kickstart files on the fly with automatic password management and templating.

## Features

- FastAPI-based REST API for kickstart file generation
- SQLite database for configuration and password storage
- Automatic password generation using memorable passphrases (e.g. `vastly-caring-filly-111`)
- Password persistence - machines get the same passwords on subsequent requests
- Jinja2 templating for flexible kickstart customization
- CSV export of machine credentials
- Static file serving for web frontend

## Quick Start

**Prerequisites:** Python 3.14+ and [uv](https://github.com/astral-sh/uv)

```bash
# Clone and install
git clone https://github.com/yourusername/provisionR.git
cd provisionR
uv sync

# Run the application
uv run provisionr
# API available at http://localhost:8000
```

### Running Tests

```bash
uv run pytest
```

## API Endpoints

### Health Check
```bash
GET /api/health
```

### Configuration Management

**Get Configuration:**
```bash
GET /api/v1/config
```

**Update Configuration:**
```bash
PUT /api/v1/config
Content-Type: application/json

{
  "target_os": "Rocky9",
  "generate_passwords": true,
  "values": {
    "hostname_prefix": "prod",
    "timezone": "America/New_York",
    "custom_key": "custom_value"
  }
}
```

### Kickstart Generation

```bash
GET /api/v1/ks?mac=AA:BB:CC:DD:EE:FF&uuid=machine-uuid&serial=SN12345

# With custom template
GET /api/v1/ks?mac=AA:BB:CC:DD:EE:FF&uuid=machine-uuid&serial=SN12345&template_name=rhel9

# With additional variables
GET /api/v1/ks?mac=AA:BB:CC:DD:EE:FF&uuid=machine-uuid&serial=SN12345&hostname=webserver01
```

**Parameters:**
- `mac` (required) - MAC address of the machine
- `uuid` (required) - UUID of the machine
- `serial` (required) - Serial number of the machine
- `template_name` (optional) - Template to use (default: "default")
- Any additional query parameters are passed to the template

### Export Machine Passwords

```bash
GET /api/v1/machines/export
```

Downloads a CSV file with all machine credentials.

## Configuration

### Global Configuration

The application stores global configuration in the SQLite database. You can configure:

- **target_os**: Target operating system (Rocky9 or Ubuntu25.04)
- **generate_passwords**: Whether to auto-generate passwords (boolean)
- **values**: Custom key-value pairs available during templating (dict)

### Templates

Kickstart templates are stored in `provisionR/templates/` with the `.ks.j2` extension.

**Available template variables:**
- `mac`, `uuid`, `serial` - Machine identifiers
- `target_os` - From global config
- `root_password`, `user_password`, `luks_password` - Auto-generated (if enabled)
- Any custom values from global config
- Any additional query parameters passed to the API

**Example template:**
```jinja2
# Kickstart file for {{ mac }}
# Generated by provisionR

# System timezone
timezone {{ timezone | default('UTC') }}

# Root password
rootpw --iscrypted {{ root_password }}

# Custom values from config
{{ custom_key }}
```

## Password Generation

Passwords are automatically generated using the petname library in the format:
```
word-word-word-123
```

Example: `vastly-caring-filly-111`

**Features:**
- Memorable and secure
- Persistent per machine (mac+uuid+serial)
- Same machine always gets the same passwords
- Can be disabled via configuration

## Database

The application uses SQLite by default:
- **Production:** `provisionr.db` in the project root
- **Tests:** In-memory database (`:memory:`)

Set `PROVISIONR_TEST_MODE=true` to use in-memory database for testing.

## Development

### Running in Development Mode

```bash
# Install dev dependencies
uv sync --dev

# Run with auto-reload (using uvicorn directly)
uv run uvicorn provisionR.app:create_app --factory --reload
```

### Pre-commit Hooks

The project uses pre-commit hooks with ruff for code quality:

```bash
# Install pre-commit hooks
uv run pre-commit install

# Run hooks manually on all files
uv run pre-commit run --all-files

# Run hooks on staged files only
uv run pre-commit run
```

The pre-commit hook will:
- Run ruff linting with auto-fix
- Run ruff formatting
- Check code before every commit

### Code Style

The project uses:
- **Ruff** for linting and formatting
- Type hints throughout
- Docstrings for all public functions
- Service layer pattern for business logic
- Dependency injection via FastAPI's Depends()

### Adding a New Template

1. Create a new `.ks.j2` file in `provisionR/templates/`
2. Use Jinja2 syntax with available variables
3. Request kickstart with `template_name` parameter

Example:
```bash
# File: provisionR/templates/rhel9.ks.j2
curl "http://localhost:8000/api/v1/ks?mac=AA:BB:CC&uuid=123&serial=SN1&template_name=rhel9"
```

## Docker Support

(Coming soon)

## License

MIT License - see LICENSE file for details

## Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Make your changes with tests
4. Ensure all tests pass
5. Submit a pull request

## API Documentation

Interactive API documentation is available when running the application:

- **Swagger UI:** http://localhost:8000/docs
- **ReDoc:** http://localhost:8000/redoc
